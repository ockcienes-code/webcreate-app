<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipari≈ü Y√∂netimi - WebCreate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
    <%- include('../partials/admin-header') %>

    <main class="container" style="min-height: 80vh; padding: 2rem 0;">
        <div class="animate-fade-in">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="color: var(--white); margin-bottom: 0.5rem;">Sipari≈ü Y√∂netimi</h1>
                    <p style="color: #ccc;">T√ºm sipari≈üleri g√∂r√ºnt√ºle ve y√∂net</p>
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="orderSearch" 
                            placeholder="Sipari≈ü ara..."
                            class="form-control" 
                            style="padding-left: 2.5rem; width: 250px;"
                        >
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #ccc;">üîç</span>
                    </div>
                    
                    <select id="orderStatusFilter" class="form-control" style="width: 180px;">
                        <option value="all">T√ºm Durumlar</option>
                        <option value="pending">‚è≥ Beklemede</option>
                        <option value="in_progress">üöÄ √úretimde</option>
                        <option value="delivered">‚úÖ Teslim Edildi</option>
                        <option value="revision">üîÑ Revizyonda</option>
                        <option value="cancelled">‚ùå ƒ∞ptal Edildi</option>
                    </select>
                    
                    <select id="orderDateFilter" class="form-control" style="width: 180px;">
                        <option value="all">T√ºm Zamanlar</option>
                        <option value="today">Bug√ºn</option>
                        <option value="week">Bu Hafta</option>
                        <option value="month">Bu Ay</option>
                        <option value="year">Bu Yƒ±l</option>
                    </select>
                    
                    <button onclick="exportOrders()" class="btn btn-outline">
                        üìä Dƒ±≈üa Aktar
                    </button>
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders"><%= orders.length %></div>
                    <div class="stat-label">Toplam Sipari≈ü</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="pendingOrders">
                        <%= orders.filter(o => o.status === 'pending').length %>
                    </div>
                    <div class="stat-label">Bekleyen</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="inProgressOrders">
                        <%= orders.filter(o => o.status === 'in_progress').length %>
                    </div>
                    <div class="stat-label">√úretimde</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="revisionOrders">
                        <%= orders.filter(o => o.status === 'revision').length %>
                    </div>
                    <div class="stat-label">Revizyonda</div>
                </div>
            </div>

            <div class="card">
                <div class="table">
                    <table style="width: 100%;" id="ordersTable">
                        <thead>
                            <tr>
                                <th>Sipari≈ü ID</th>
                                <th>Kullanƒ±cƒ±</th>
                                <th>Ba≈ülƒ±k</th>
                                <th>Durum</th>
                                <th>Fiyat</th>
                                <th>Teslim Tarihi</th>
                                <th>Olu≈üturulma</th>
                                <th>√ñncelik</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (orders.length > 0) { %>
                                <% orders.forEach(order => { %>
                                <tr data-order="<%= order._id %>">
                                    <td>
                                        <div style="color: #ccc; font-family: monospace; font-size: 0.875rem;">
                                            #<%= order._id.toString().substring(18, 24) %>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <div style="color: var(--white); font-weight: 500;"><%= order.user.name %></div>
                                            <div style="color: #ccc; font-size: 0.875rem;"><%= order.user.email %></div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="max-width: 200px;">
                                            <div style="color: var(--white); font-weight: 500; margin-bottom: 0.25rem;">
                                                <%= order.title %>
                                            </div>
                                            <div style="color: #ccc; font-size: 0.875rem; line-height: 1.3;">
                                                <%= order.description.substring(0, 50) %>...
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge status-<%= order.status %>">
                                            <%
                                                const statusText = {
                                                    'pending': '‚è≥ Beklemede',
                                                    'in_progress': 'üöÄ √úretimde',
                                                    'delivered': '‚úÖ Teslim Edildi',
                                                    'revision': 'üîÑ Revizyonda',
                                                    'cancelled': '‚ùå ƒ∞ptal Edildi'
                                                };
                                            %>
                                            <%= statusText[order.status] %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (order.price > 0) { %>
                                            <span style="color: var(--white); font-weight: 500;">
                                                <%= order.price %> TL
                                            </span>
                                        <% } else { %>
                                            <span style="color: #ccc;">-</span>
                                        <% } %>
                                    </td>
                                    
                                    <td>
                                        <% if (order.deadline) { %>
                                            <span style="color: #ccc;">
                                                <%= new Date(order.deadline).toLocaleDateString('tr-TR') %>
                                            </span>
                                        <% } else { %>
                                            <span style="color: #ccc;">-</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <span style="color: #ccc;">
                                            <%= new Date(order.createdAt).toLocaleDateString('tr-TR') %>
                                        </span>
                                    </td>
                                    <td>
                                        <%
                                            const priorityIcons = {
                                                'low': 'üîµ',
                                                'medium': 'üü°',
                                                'high': 'üü†',
                                                'urgent': 'üî¥'
                                            };
                                        %>
                                        <span title="<%= order.priority %>">
                                            <%= priorityIcons[order.priority] %>
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <a href="/admin/orders/<%= order._id %>" class="btn" style="padding: 0.25rem 0.5rem;" title="Detaylarƒ± G√∂r">
                                                üëÅÔ∏è
                                            </a>
                                            <button onclick="updateOrderStatus('<%= order._id %>')" class="btn btn-outline" style="padding: 0.25rem 0.5rem;" title="Durum G√ºncelle">
                                                ‚úèÔ∏è
                                            </button>
                                            <button onclick="sendMessage('<%= order.user._id %>', '<%= order.user.name %>', '<%= order.title %>')" class="btn btn-outline" style="padding: 0.25rem 0.5rem;" title="Mesaj G√∂nder">
                                                üí¨
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 3rem; color: #ccc;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                                        <h3 style="color: var(--white); margin-bottom: 0.5rem;">Hen√ºz sipari≈ü bulunmuyor</h3>
                                        <p>M√º≈üteriler sipari≈ü olu≈üturduƒüunda burada listelenecek</p>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <% if (orders.length > 0) { %>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                <div style="color: #ccc;">
                    Toplam <strong><%= orders.length %></strong> sipari≈ü
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn btn-outline">‚Üê √ñnceki</button>
                    <span style="color: #ccc; padding: 0.5rem 1rem;">Sayfa 1</span>
                    <button class="btn btn-outline">Sonraki ‚Üí</button>
                </div>
            </div>
            <% } %>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <div id="statusModal" class="modal" style="display: none;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--white); margin: 0;">Sipari≈ü Durumu G√ºncelle</h3>
                <button onclick="closeStatusModal()" style="background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            
            <form id="statusForm">
                <input type="hidden" id="statusOrderId">
                
                <div class="form-group">
                    <label class="form-label">Yeni Durum</label>
                    <select id="newStatus" class="form-control" required>
                        <option value="">Durum se√ßin</option>
                        <option value="pending">‚è≥ Beklemede</option>
                        <option value="in_progress">üöÄ √úretimde</option>
                        <option value="delivered">‚úÖ Teslim Edildi</option>
                        <option value="cancelled">‚ùå ƒ∞ptal Edildi</option>
                    </select>
                </div>
                
                <div class="form-group" id="priceGroup" style="display: none;">
                    <label for="orderPrice" class="form-label">Fiyat (TL)</label>
                    <input type="number" id="orderPrice" class="form-control" min="0" step="0.01">
                </div>
                
                <div class="form-group" id="deadlineGroup" style="display: none;">
                    <label for="orderDeadline" class="form-label">Teslim Tarihi</label>
                    <input type="date" id="orderDeadline" class="form-control">
                </div>
                
                <div class="form-group" id="cancellationGroup" style="display: none;">
                    <label for="cancellationReason" class="form-label">ƒ∞ptal Nedeni</label>
                    <textarea id="cancellationReason" class="form-control" rows="3" placeholder="ƒ∞ptal nedenini a√ßƒ±klayƒ±n..."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" onclick="closeStatusModal()" class="btn btn-outline" style="flex: 1;">
                        ƒ∞ptal
                    </button>
                    <button type="submit" class="btn" style="flex: 1;">
                        üìù G√ºncelle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="sendMessageModal" class="modal" style="display: none;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--white); margin: 0;">Kullanƒ±cƒ±ya Mesaj G√∂nder</h3>
                <button onclick="closeSendMessageModal()" style="background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            <form id="sendMessageForm">
                <input type="hidden" id="messageUserId" name="userId">
                <div class="form-group">
                    <label class="form-label">Alƒ±cƒ±</label>
                    <input type="text" id="messageUserName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="messageTitle" class="form-label">Ba≈ülƒ±k</label>
                    <input type="text" id="messageTitle" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="messageContent" class="form-label">Mesaj</label>
                    <textarea id="messageContent" name="message" class="form-control" rows="5" required></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" onclick="closeSendMessageModal()" class="btn btn-outline" style="flex: 1;">ƒ∞ptal</button>
                    <button type="submit" class="btn" style="flex: 1;">G√∂nder</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script src="/js/admin.js"></script>
    <script>
    // Sipari≈ü arama
    document.getElementById('orderSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#ordersTable tbody tr');
        
        rows.forEach(row => {
            const orderTitle = row.cells[2].textContent.toLowerCase();
            const userName = row.cells[1].textContent.toLowerCase();
            
            if (orderTitle.includes(searchTerm) || userName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Durum filtreleme
    document.getElementById('orderStatusFilter').addEventListener('change', function(e) {
        const status = e.target.value;
        const rows = document.querySelectorAll('#ordersTable tbody tr');
        
        rows.forEach(row => {
            if (status === 'all') {
                row.style.display = '';
            } else {
                const statusClass = row.querySelector('.status-badge').className;
                if (statusClass.includes(`status-${status}`)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    });

    // Sipari≈ü durumu g√ºncelleme modalƒ±nƒ± a√ß
    function updateOrderStatus(orderId) {
        document.getElementById('statusOrderId').value = orderId;
        document.getElementById('statusModal').style.display = 'flex';
    }

    function closeStatusModal() {
        document.getElementById('statusModal').style.display = 'none';
        document.getElementById('statusForm').reset();
        hideAllOptionGroups();
    }

    // Durum se√ßimine g√∂re ek alanlarƒ± g√∂ster/gizle
    document.getElementById('newStatus').addEventListener('change', function(e) {
        hideAllOptionGroups();
        
        switch(e.target.value) {
            case 'in_progress':
                document.getElementById('priceGroup').style.display = 'block';
                document.getElementById('deadlineGroup').style.display = 'block';
                break;
            case 'cancelled':
                document.getElementById('cancellationGroup').style.display = 'block';
                break;
        }
    });

    function hideAllOptionGroups() {
        document.getElementById('priceGroup').style.display = 'none';
        document.getElementById('deadlineGroup').style.display = 'none';
        document.getElementById('cancellationGroup').style.display = 'none';
    }

    // Durum g√ºncelleme formu
    document.getElementById('statusForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const orderId = document.getElementById('statusOrderId').value;
        const status = document.getElementById('newStatus').value;
        const price = document.getElementById('orderPrice').value;
        const deadline = document.getElementById('orderDeadline').value;
        const cancellationReason = document.getElementById('cancellationReason').value;
        
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '‚è≥ G√ºncelleniyor...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/admin/orders/${orderId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status,
                    price: price || undefined,
                    deadline: deadline || undefined,
                    cancellationReason: cancellationReason || undefined
                })
            });
            const data = await response.json();
            
            if (data.success) {
                showNotification('Sipari≈ü durumu ba≈üarƒ±yla g√ºncellendi!', 'success');
                closeStatusModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(data.error || 'Durum g√ºncellenirken bir hata olu≈ütu!', 'error');
                submitBtn.innerHTML = 'üìù G√ºncelle';
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Durum g√ºncelleme hatasƒ±:', error);
            showNotification('ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu!', 'error');
            submitBtn.innerHTML = 'üìù G√ºncelle';
            submitBtn.disabled = false;
        }
    });

    // Mesajla≈üma Modal Fonksiyonlarƒ±
    function sendMessage(userId, userName, orderTitle) {
        document.getElementById('messageUserId').value = userId;
        document.getElementById('messageUserName').value = userName;
        document.getElementById('messageTitle').value = `Sipari≈üiniz Hk: ${orderTitle}`;
        document.getElementById('sendMessageModal').style.display = 'flex';
    }

    function closeSendMessageModal() {
        document.getElementById('sendMessageModal').style.display = 'none';
    }

    document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'G√∂nderiliyor...';

        try {
            const response = await fetch('/admin/messages/send-to-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showNotification('Mesaj ba≈üarƒ±yla g√∂nderildi!', 'success');
                closeSendMessageModal();
            } else {
                showNotification(result.error || 'Mesaj g√∂nderilemedi!', 'error');
            }
        } catch (error) {
            showNotification('Bir hata olu≈ütu!', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'G√∂nder';
        }
    });

    // Sipari≈üleri dƒ±≈üa aktarma
    function exportOrders() {
        const table = document.getElementById('ordersTable');
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim()).slice(0, -1); // Son s√ºtun (ƒ∞≈ülemler) hari√ß
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        if(rows.length === 0 || rows[0].querySelectorAll('td').length <= 1) {
            showNotification('Dƒ±≈üa aktarƒ±lacak sipari≈ü yok.', 'warning');
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n';
        
        rows.forEach(row => {
            const rowData = Array.from(row.querySelectorAll('td')).map(td => `"${td.innerText.replace(/"/g, '""').replace(/\n/g, ' ')}"`).slice(0, -1);
            csvContent += rowData.join(',') + '\n';
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', 'siparisler.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Sipari≈üler dƒ±≈üa aktarƒ±ldƒ±!', 'success');
    }

    // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapatma
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                if(this.id === 'statusModal') closeStatusModal();
                if(this.id === 'sendMessageModal') closeSendMessageModal();
            }
        });
    });
    </script>
</body>
</html>