<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipari≈ü Detayƒ± - WebCreate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
    <%- include('../partials/admin-header') %>

    <main class="container" style="min-height: 80vh; padding: 2rem 0;">
        <div class="animate-fade-in">
            <!-- √úst Bilgi ve ƒ∞≈ülemler -->
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 2rem; gap: 2rem; flex-wrap: wrap;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <h1 style="color: var(--white); margin: 0;"><%= order.title %></h1>
                        <span class="status-badge status-<%= order.status %>" style="font-size: 1.1rem;">
                            <%
                                const statusText = {
                                    'pending': '‚è≥ Beklemede',
                                    'in_progress': 'üöÄ √úretimde',
                                    'delivered': '‚úÖ Teslim Edildi',
                                    'revision': 'üîÑ Revizyonda',
                                    'cancelled': '‚ùå ƒ∞ptal Edildi'
                                };
                            %>
                            <%= statusText[order.status] %>
                        </span>
                    </div>
                    
                    <p style="color: #ccc; line-height: 1.6; margin-bottom: 1.5rem;"><%= order.description %></p>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <% if (order.price > 0) { %>
                        <div style="background: var(--medium-gray); padding: 0.75rem 1rem; border-radius: 5px;">
                            <strong style="color: var(--white);">üíµ <%= order.price %> TL</strong>
                        </div>
                        <% } %>
                        
                        <% if (order.deadline) { %>
                        <div style="background: var(--medium-gray); padding: 0.75rem 1rem; border-radius: 5px;">
                            <strong style="color: var(--white);">üìÖ <%= new Date(order.deadline).toLocaleDateString('tr-TR') %></strong>
                        </div>
                        <% } %>
                        
                        <div style="background: var(--medium-gray); padding: 0.75rem 1rem; border-radius: 5px;">
                            <strong style="color: var(--white);">üë§ <%= order.user.name %></strong>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <a href="/admin/orders" class="btn btn-outline">
                        ‚Üê Sipari≈ülere D√∂n
                    </a>
                    
                    <button onclick="updateOrderStatus()" class="btn">
                        ‚úèÔ∏è Durumu G√ºncelle
                    </button>
                    
                    <% if (order.status === 'in_progress' || order.status === 'revision') { %>
                    <button onclick="openDeliveryModal()" class="btn btn-success">
                        üì¶ Teslim Et
                    </button>
                    <% } %>
                    
                    <button onclick="sendMessageToUser()" class="btn btn-outline">
                        üí¨ Mesaj G√∂nder
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- Sol Kolon -->
                <div class="col">
                    <!-- Sipari≈ü Bilgileri -->
                    <div class="card">
                        <h3 style="color: var(--white); margin-bottom: 1.5rem;">üìã Sipari≈ü Bilgileri</h3>
                        
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #ccc; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Sipari≈ü ID</label>
                                    <div style="color: var(--white); font-family: monospace;">
                                        #<%= order._id.toString().substring(18, 24) %>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="color: #ccc; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">√ñncelik</label>
                                    <div style="color: var(--white);">
                                        <%
                                            const priorityText = {
                                                'low': 'üîµ D√º≈ü√ºk',
                                                'medium': 'üü° Orta',
                                                'high': 'üü† Y√ºksek',
                                                'urgent': 'üî¥ Acil'
                                            };
                                        %>
                                        <%= priorityText[order.priority] %>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #ccc; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Olu≈üturulma</label>
                                    <div style="color: var(--white);">
                                        <%= new Date(order.createdAt).toLocaleDateString('tr-TR') %>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="color: #ccc; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Son G√ºncelleme</label>
                                    <div style="color: var(--white);">
                                        <%= new Date(order.updatedAt).toLocaleDateString('tr-TR') %>
                                    </div>
                                </div>
                            </div>
                            
                            <% if (order.tags && order.tags.length > 0) { %>
                            <div>
                                <label style="color: #ccc; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Etiketler</label>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <% order.tags.forEach(tag => { %>
                                    <span style="background: var(--accent); color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.875rem;">
                                        <%= tag %>
                                    </span>
                                    <% }); %>
                                </div>
                            </div>
                            <% } %>
                            
                            <% if (order.adminNotes) { %>
                            <div>
                                <label style="color: #ccc; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Admin Notlarƒ±</label>
                                <div style="color: var(--white); background: var(--medium-gray); padding: 1rem; border-radius: 5px; line-height: 1.6;">
                                    <%= order.adminNotes %>
                                </div>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Kullanƒ±cƒ± Bilgileri -->
                    <div class="card">
                        <h3 style="color: var(--white); margin-bottom: 1.5rem;">üë§ Kullanƒ±cƒ± Bilgileri</h3>
                        
                        <div style="display: flex; gap: 1.5rem; align-items: start;">
                            <div style="width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; font-weight: bold;">
                                <%= order.user.name.charAt(0).toUpperCase() %>
                            </div>
                            
                            <div style="flex: 1;">
                                <div style="color: var(--white); font-weight: 500; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                    <%= order.user.name %>
                                </div>
                                
                                <div style="color: #ccc; margin-bottom: 0.5rem;">
                                    üìß <%= order.user.email %>
                                </div>
                                
                                <% if (order.user.phone) { %>
                                <div style="color: #ccc; margin-bottom: 0.5rem;">
                                    üìû <%= order.user.phone %>
                                </div>
                                <% } %>
                                
                                <% if (order.user.company) { %>
                                <div style="color: #ccc; margin-bottom: 1rem;">
                                    üè¢ <%= order.user.company %>
                                </div>
                                <% } %>
                                
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="viewUserOrders('<%= order.user._id %>')" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                        üì¶ Sipari≈üleri
                                    </button>
                                    <button onclick="sendMessageToUser()" class="btn" style="padding: 0.5rem 1rem;">
                                        üí¨ Mesaj G√∂nder
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Y√ºklenen Dosyalar -->
                    <div class="card">
                        <h3 style="color: var(--white); margin-bottom: 1.5rem;">üìé Kullanƒ±cƒ± Dosyalarƒ±</h3>
                        
                        <% if (order.files && order.files.length > 0) { %>
                            <div style="display: grid; gap: 0.75rem;">
                                <% order.files.forEach((file, index) => { %>
                                <div style="display: flex; justify-content: between; align-items: center; padding: 1rem; background: var(--medium-gray); border-radius: 5px;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="font-size: 1.5rem;">
                                            <%= getFileIcon(file.originalName) %>
                                        </div>
                                        <div>
                                            <div style="color: var(--white); font-weight: 500;"><%= file.originalName %></div>
                                            <div style="color: #ccc; font-size: 0.875rem;">
                                                <%= new Date(file.uploadedAt).toLocaleDateString('tr-TR') %>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 0.5rem;">
                                        <a href="/files/download/<%= file.filename %>" class="btn" style="padding: 0.5rem 1rem;">
                                            üì• ƒ∞ndir
                                        </a>
                                        <button onclick="previewFile('<%= file.filename %>')" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                            üëÅÔ∏è √ñnizleme
                                        </button>
                                    </div>
                                </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div style="text-align: center; padding: 2rem; color: #ccc;">
                                <p>Kullanƒ±cƒ± hen√ºz dosya y√ºklememi≈ü.</p>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Saƒü Kolon -->
                <div class="col">
                    <!-- Teslim Edilen Dosyalar -->
                    <% if (order.deliveryFiles && order.deliveryFiles.length > 0) { %>
                    <div class="card">
                        <h3 style="color: var(--white); margin-bottom: 1.5rem;">üéÅ Teslim Edilen Dosyalar</h3>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <% order.deliveryFiles.forEach((file, index) => { %>
                            <div style="display: flex; justify-content: between; align-items: center; padding: 1rem; background: var(--medium-gray); border-radius: 5px; border-left: 4px solid var(--success);">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="font-size: 1.5rem;">
                                        <%= getFileIcon(file.originalName) %>
                                    </div>
                                    <div>
                                        <div style="color: var(--white); font-weight: 500;"><%= file.originalName %></div>
                                        <div style="color: #ccc; font-size: 0.875rem;">
                                            <%= new Date(file.deliveredAt).toLocaleDateString('tr-TR') %>
                                        </div>
                                    </div>
                                </div>
                                
                                <a href="/files/download/<%= file.filename %>" class="btn btn-success" style="padding: 0.5rem 1rem;">
                                    üì• ƒ∞ndir
                                </a>
                            </div>
                            <% }); %>
                        </div>
                    </div>
                    <% } %>

                    <!-- Revizyon ƒ∞steƒüi -->
                    <% if (order.revisionRequest && order.revisionRequest.requested) { %>
                    <div class="card">
                        <h3 style="color: var(--white); margin-bottom: 1.5rem;">üîÑ Revizyon ƒ∞steƒüi</h3>
                        
                        <div style="background: var(--medium-gray); padding: 1.5rem; border-radius: 5px; border-left: 4px solid var(--warning);">
                            <div style="margin-bottom: 1rem;">
                                <strong style="color: var(--white); display: block; margin-bottom: 0.5rem;">Kullanƒ±cƒ± A√ßƒ±klamasƒ±:</strong>
                                <p style="color: #ccc; line-height: 1.6;"><%= order.revisionRequest.description %></p>
                            </div>
                            
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <span class="status-badge status-<%= order.revisionRequest.status %>">
                                        <%
                                            const revisionStatus = {
                                                'pending': '‚è≥ Beklemede',
                                                'accepted': '‚úÖ Kabul Edildi',
                                                'rejected': '‚ùå Reddedildi',
                                                'counter_offer': 'üí° Kar≈üƒ± Teklif'
                                            };
                                        %>
                                        <%= revisionStatus[order.revisionRequest.status] %>
                                    </span>
                                </div>
                                
                                <div style="color: #ccc; font-size: 0.875rem;">
                                    <%= new Date(order.revisionRequest.requestedAt).toLocaleDateString('tr-TR') %>
                                </div>
                            </div>
                            
                            <% if (order.revisionRequest.counterOffer) { %>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
                                <strong style="color: var(--white); display: block; margin-bottom: 0.5rem;">Admin Yanƒ±tƒ±:</strong>
                                <p style="color: #ccc; line-height: 1.6;"><%= order.revisionRequest.counterOffer %></p>
                            </div>
                            <% } %>
                            
                            <% if (order.revisionRequest.status === 'pending') { %>
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button onclick="acceptRevision('<%= order._id %>')" class="btn btn-success" style="flex: 1;">
                                    ‚úÖ Kabul Et
                                </button>
                                <button onclick="rejectRevision('<%= order._id %>')" class="btn btn-danger" style="flex: 1;">
                                    ‚ùå Reddet
                                </button>
                                <button onclick="counterOfferRevision('<%= order._id %>')" class="btn btn-outline" style="flex: 1;">
                                    üí° Kar≈üƒ± Teklif
                                </button>
                            </div>
                            <% } %>
                        </div>
                    </div>
                    <% } %>

                    <!-- ƒ∞ptal Nedeni -->
                    <% if (order.status === 'cancelled' && order.cancellationReason) { %>
                    <div class="card">
                        <h3 style="color: var(--white); margin-bottom: 1.5rem;">‚ùå ƒ∞ptal Nedeni</h3>
                        
                        <div style="background: rgba(220, 53, 69, 0.1); padding: 1.5rem; border-radius: 5px; border-left: 4px solid var(--danger);">
                            <p style="color: #ccc; line-height: 1.6; margin: 0;"><%= order.cancellationReason %></p>
                        </div>
                    </div>
                    <% } %>

                    <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
                    <div class="card">
                        <h3 style="color: var(--white); margin-bottom: 1.5rem;">‚ö° Hƒ±zlƒ± ƒ∞≈ülemler</h3>
                        
                        <div style="display: grid; gap: 1rem;">
                            <button onclick="updateOrderStatus()" class="btn hover-lift" style="text-align: left; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.2rem;">‚úèÔ∏è</span>
                                    <div>
                                        <div style="color: var(--white); font-weight: 500;">Durumu G√ºncelle</div>
                                        <div style="color: #ccc; font-size: 0.875rem;">Sipari≈ü durumunu deƒüi≈ütir</div>
                                    </div>
                                </div>
                            </button>
                            
                            <% if (order.status === 'in_progress' || order.status === 'revision') { %>
                            <button onclick="openDeliveryModal()" class="btn btn-success hover-lift" style="text-align: left; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.2rem;">üì¶</span>
                                    <div>
                                        <div style="color: var(--white); font-weight: 500;">Teslim Et</div>
                                        <div style="color: #ccc; font-size: 0.875rem;">Dosyalarƒ± kullanƒ±cƒ±ya teslim et</div>
                                    </div>
                                </div>
                            </button>
                            <% } %>
                            
                            <button onclick="addAdminNotes()" class="btn btn-outline hover-lift" style="text-align: left; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.2rem;">üìù</span>
                                    <div>
                                        <div style="color: var(--white); font-weight: 500;">Not Ekle</div>
                                        <div style="color: #ccc; font-size: 0.875rem;">ƒ∞√ß not ekle veya d√ºzenle</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="sendMessageToUser()" class="btn btn-outline hover-lift" style="text-align: left; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.2rem;">üí¨</span>
                                    <div>
                                        <div style="color: var(--white); font-weight: 500;">Mesaj G√∂nder</div>
                                        <div style="color: #ccc; font-size: 0.875rem;">Kullanƒ±cƒ±ya mesaj g√∂nder</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="/js/main.js"></script>
    <script src="/js/admin.js"></script>

    <!-- Durum G√ºncelleme Modal -->
    <div id="statusModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--white); margin: 0;">Sipari≈ü Durumu G√ºncelle</h3>
                <button onclick="closeStatusModal()" style="background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            
            <form id="statusForm">
                <input type="hidden" id="statusOrderId" value="<%= order._id %>">
                
                <div class="form-group">
                    <label class="form-label">Yeni Durum</label>
                    <select id="newStatus" class="form-control" required>
                        <option value="">Durum se√ßin</option>
                        <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>‚è≥ Beklemede</option>
                        <option value="in_progress" <%= order.status === 'in_progress' ? 'selected' : '' %>>üöÄ √úretimde</option>
                        <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>‚úÖ Teslim Edildi</option>
                        <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>‚ùå ƒ∞ptal Edildi</option>
                    </select>
                </div>
                
                <div class="form-group" id="priceGroup" style="display: none;">
                    <label for="orderPrice" class="form-label">Fiyat (TL)</label>
                    <input type="number" id="orderPrice" class="form-control" min="0" step="0.01" value="<%= order.price || '' %>">
                </div>
                
                <div class="form-group" id="deadlineGroup" style="display: none;">
                    <label for="orderDeadline" class="form-label">Teslim Tarihi</label>
                    <input type="date" id="orderDeadline" class="form-control" value="<%= order.deadline ? new Date(order.deadline).toISOString().split('T')[0] : '' %>">
                </div>
                
                <div class="form-group" id="cancellationGroup" style="display: none;">
                    <label for="cancellationReason" class="form-label">ƒ∞ptal Nedeni</label>
                    <textarea id="cancellationReason" class="form-control" rows="3" placeholder="ƒ∞ptal nedenini a√ßƒ±klayƒ±n..."><%= order.cancellationReason || '' %></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" onclick="closeStatusModal()" class="btn btn-outline" style="flex: 1;">
                        ƒ∞ptal
                    </button>
                    <button type="submit" class="btn" style="flex: 1;">
                        üìù G√ºncelle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Teslim Modal -->
    <div id="deliveryModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 90%;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--white); margin: 0;">Sipari≈üi Teslim Et</h3>
                <button onclick="closeDeliveryModal()" style="background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            
            <form id="deliveryForm" enctype="multipart/form-data">
                <input type="hidden" name="orderId" value="<%= order._id %>">
                
                <div class="form-group">
                    <label class="form-label">Teslim Dosyalarƒ±</label>
                    <div class="file-upload" onclick="document.getElementById('deliveryFiles').click()" style="cursor: pointer;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìÅ</div>
                        <h4 style="color: var(--white); margin-bottom: 0.5rem;">Dosyalarƒ± Buraya S√ºr√ºkleyin veya Tƒ±klayƒ±n</h4>
                        <p style="color: #ccc; margin-bottom: 1rem;">
                            Tamamlanmƒ±≈ü web sitesi dosyalarƒ±nƒ± y√ºkleyin
                        </p>
                        <input 
                            type="file" 
                            id="deliveryFiles" 
                            name="deliveryFiles" 
                            multiple 
                            style="display: none;"
                        >
                    </div>
                    <div id="deliveryFilePreview" style="margin-top: 1rem;"></div>
                </div>
                
                <div class="form-group">
                    <label for="deliveryNotes" class="form-label">Teslim Notlarƒ± (Opsiyonel)</label>
                    <textarea 
                        id="deliveryNotes" 
                        name="deliveryNotes" 
                        class="form-control" 
                        rows="3"
                        placeholder="Teslim ile ilgili notlarƒ±nƒ±z..."
                    ></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" onclick="closeDeliveryModal()" class="btn btn-outline" style="flex: 1;">
                        ƒ∞ptal
                    </button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">
                        üì¶ Teslim Et
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="sendMessageModal" class="modal" style="display: none;">
    <div class="card" style="max-width: 500px; width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: var(--white); margin: 0;">Kullanƒ±cƒ±ya Mesaj G√∂nder</h3>
            <button onclick="closeSendMessageModal()" style="background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        <form id="sendMessageForm">
            <input type="hidden" id="messageUserId" name="userId" value="<%= order.user._id %>">
            <div class="form-group">
                <label for="messageTitle" class="form-label">Ba≈ülƒ±k</label>
                <input type="text" id="messageTitle" name="title" class="form-control" value="Sipari≈üiniz Hakkƒ±nda: <%= order.title %>" required>
            </div>
            <div class="form-group">
                <label for="messageContent" class="form-label">Mesaj</label>
                <textarea id="messageContent" name="message" class="form-control" rows="5" required></textarea>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" onclick="closeSendMessageModal()" class="btn btn-outline" style="flex: 1;">ƒ∞ptal</button>
                <button type="submit" class="btn" style="flex: 1;">G√∂nder</button>
            </div>
        </form>
    </div>
</div>

    <script>
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'zip': 'üì¶', 'rar': 'üì¶', 'pdf': 'üìÑ',
            'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è',
            'doc': 'üìù', 'docx': 'üìù', 'html': 'üåê',
            'css': 'üé®', 'js': '‚ö°', 'php': 'üêò'
        };
        return icons[ext] || 'üìÑ';
    }

    function updateOrderStatus() {
        document.getElementById('statusModal').style.display = 'flex';
    }

    function closeStatusModal() {
        document.getElementById('statusModal').style.display = 'none';
    }

    function openDeliveryModal() {
        document.getElementById('deliveryModal').style.display = 'flex';
    }

    function closeDeliveryModal() {
        document.getElementById('deliveryModal').style.display = 'none';
        document.getElementById('deliveryForm').reset();
        document.getElementById('deliveryFilePreview').innerHTML = '';
    }

    function viewUserOrders(userId) {
        window.location.href = `/admin/orders?user=${userId}`;
    }

    function sendMessageToUser() {
    document.getElementById('sendMessageModal').style.display = 'flex';
}
    function closeSendMessageModal() {
    document.getElementById('sendMessageModal').style.display = 'none';
}

document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/admin/messages/send-to-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            showNotification('Mesaj ba≈üarƒ±yla g√∂nderildi!', 'success');
            closeSendMessageModal();
        } else {
            showNotification(result.error || 'Mesaj g√∂nderilemedi!', 'error');
        }
    } catch (error) {
        showNotification('Bir hata olu≈ütu!', 'error');
    }
});

    function previewFile(filename) {
        window.open(`/files/preview/${filename}`, '_blank');
    }

    async function addAdminNotes() {
    const currentNotes = `<%= order.adminNotes || '' %>`;
    const newNotes = prompt('Admin notlarƒ±nƒ± girin:', currentNotes);
    
    if (newNotes !== null) {
        try {
            const response = await fetch(`/admin/orders/<%= order._id %>/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: newNotes })
            });
            const result = await response.json();
            if (result.success) {
                showNotification('Admin notlarƒ± g√ºncellendi!', 'success');
                // Sayfayƒ± yenilemek en kolayƒ±
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showNotification(result.error || 'Not g√ºncellenemedi!', 'error');
            }
        } catch(error) {
            showNotification('Bir hata olu≈ütu!', 'error');
        }
    }
}

    // Revizyon i≈ülemleri
    function acceptRevision(orderId) {
        if (confirm('Bu revizyon isteƒüini kabul etmek istediƒüinizden emin misiniz?')) {
            submitRevisionDecision(orderId, 'accepted');
        }
    }

    function rejectRevision(orderId) {
        const reason = prompt('Reddetme nedeninizi belirtin:');
        if (reason !== null) {
            submitRevisionDecision(orderId, 'rejected', reason);
        }
    }

    function counterOfferRevision(orderId) {
        const offer = prompt('Kar≈üƒ± teklifinizi belirtin:');
        if (offer !== null) {
            submitRevisionDecision(orderId, 'counter_offer', offer);
        }
    }

    async function submitRevisionDecision(orderId, decision, message = '') {
        try {
            const response = await fetch(`/admin/revisions/${orderId}/decision`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    decision,
                    counterOffer: message
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Revizyon kararƒ± g√∂nderildi!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(data.error || 'Karar g√∂nderilirken bir hata olu≈ütu!', 'error');
            }
        } catch (error) {
            console.error('Revizyon kararƒ± g√∂nderme hatasƒ±:', error);
            showNotification('ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu!', 'error');
        }
    }

    // Durum g√ºncelleme formu
    document.getElementById('statusForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const orderId = document.getElementById('statusOrderId').value;
        const status = document.getElementById('newStatus').value;
        const price = document.getElementById('orderPrice').value;
        const deadline = document.getElementById('orderDeadline').value;
        const cancellationReason = document.getElementById('cancellationReason').value;
        
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '‚è≥ G√ºncelleniyor...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/admin/orders/${orderId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status,
                    price: price || undefined,
                    deadline: deadline || undefined,
                    cancellationReason: cancellationReason || undefined
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Sipari≈ü durumu ba≈üarƒ±yla g√ºncellendi!', 'success');
                closeStatusModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(data.error || 'Durum g√ºncellenirken bir hata olu≈ütu!', 'error');
                submitBtn.innerHTML = 'üìù G√ºncelle';
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Durum g√ºncelleme hatasƒ±:', error);
            showNotification('ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu!', 'error');
            submitBtn.innerHTML = 'üìù G√ºncelle';
            submitBtn.disabled = false;
        }
    });

    // Teslim formu
    document.getElementById('deliveryForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        
        submitBtn.innerHTML = '‚è≥ Teslim Ediliyor...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/admin/orders/${formData.get('orderId')}/deliver`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Sipari≈ü ba≈üarƒ±yla teslim edildi!', 'success');
                closeDeliveryModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(data.error || 'Teslim sƒ±rasƒ±nda bir hata olu≈ütu!', 'error');
                submitBtn.innerHTML = 'üì¶ Teslim Et';
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Teslim hatasƒ±:', error);
            showNotification('ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu!', 'error');
            submitBtn.innerHTML = 'üì¶ Teslim Et';
            submitBtn.disabled = false;
        }
    });

    // Dosya y√ºkleme √∂nizleme
    document.getElementById('deliveryFiles').addEventListener('change', function(e) {
        const preview = document.getElementById('deliveryFilePreview');
        preview.innerHTML = '';
        
        if (this.files.length > 0) {
            const fileList = document.createElement('div');
            fileList.style.cssText = 'display: grid; gap: 0.5rem;';
            
            Array.from(this.files).forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--medium-gray); border-radius: 5px;';
                
                fileItem.innerHTML = `
                    <div style="font-size: 1.5rem;">${getFileIcon(file.name)}</div>
                    <div style="flex: 1;">
                        <div style="color: var(--white); font-weight: 500;">${file.name}</div>
                        <div style="color: #ccc; font-size: 0.875rem;">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" onclick="removeDeliveryFile(${index})" style="background: var(--danger); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">
                        √ó
                    </button>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            preview.appendChild(fileList);
        }
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function removeDeliveryFile(index) {
        const input = document.getElementById('deliveryFiles');
        const files = Array.from(input.files);
        files.splice(index, 1);
        
        const newFileList = new DataTransfer();
        files.forEach(file => newFileList.items.add(file));
        input.files = newFileList.files;
        
        input.dispatchEvent(new Event('change'));
    }

    // Durum deƒüi≈üikliƒüine g√∂re alanlarƒ± g√∂ster/gizle
    document.getElementById('newStatus').addEventListener('change', function(e) {
        hideAllOptionGroups();
        
        switch(e.target.value) {
            case 'in_progress':
                document.getElementById('priceGroup').style.display = 'block';
                document.getElementById('deadlineGroup').style.display = 'block';
                break;
            case 'cancelled':
                document.getElementById('cancellationGroup').style.display = 'block';
                break;
        }
    });

    function hideAllOptionGroups() {
        document.getElementById('priceGroup').style.display = 'none';
        document.getElementById('deadlineGroup').style.display = 'none';
        document.getElementById('cancellationGroup').style.display = 'none';
    }

    // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapatma
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                if (this.id === 'statusModal') closeStatusModal();
                if (this.id === 'deliveryModal') closeDeliveryModal();
            }
        });
    });

    // Sayfa y√ºklendiƒüinde mevcut duruma g√∂re alanlarƒ± g√∂ster
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('newStatus').value === 'in_progress') {
            document.getElementById('priceGroup').style.display = 'block';
            document.getElementById('deadlineGroup').style.display = 'block';
        }
    });
    </script>
</body>
</html>