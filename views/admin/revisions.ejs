<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revizyon Y√∂netimi - WebCreate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
    <!-- Header -->
    <% if (user) { %>
        <% if (user.role === 'admin') { %>
            <%- include('../partials/admin-header') %>
        <% } else { %>
            <%- include('../partials/user-header') %>
        <% } %>
    <% } else { %>
        <%- include('../partials/header') %>
    <% } %>

    <main class="container" style="min-height: 80vh; padding: 2rem 0;">
        <div class="animate-fade-in">
            <!-- Ba≈ülƒ±k ve Filtreler -->
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="color: var(--white); margin-bottom: 0.5rem;">Revizyon Y√∂netimi</h1>
                    <p style="color: #ccc;">Bekleyen revizyon istekleri ve y√∂netimi</p>
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <select id="revisionFilter" class="form-control" style="width: 200px;">
                        <option value="all">T√ºm Revizyonlar</option>
                        <option value="pending">‚è≥ Bekleyenler</option>
                        <option value="accepted">‚úÖ Kabul Edilenler</option>
                        <option value="rejected">‚ùå Reddedilenler</option>
                        <option value="counter_offer">üí° Kar≈üƒ± Teklifler</option>
                    </select>
                    
                    <div style="color: #ccc; background: var(--medium-gray); padding: 0.5rem 1rem; border-radius: 5px;">
                        <strong><%= revisions.length %></strong> revizyon
                    </div>
                </div>
            </div>

            <!-- ƒ∞statistik Kartlarƒ± -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-number">
                        <%= revisions.filter(r => r.revisionRequest.status === 'pending').length %>
                    </div>
                    <div class="stat-label">Bekleyen</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">
                        <%= revisions.filter(r => r.revisionRequest.status === 'accepted').length %>
                    </div>
                    <div class="stat-label">Kabul Edilen</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">
                        <%= revisions.filter(r => r.revisionRequest.status === 'rejected').length %>
                    </div>
                    <div class="stat-label">Reddedilen</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">
                        <%= revisions.filter(r => r.revisionRequest.status === 'counter_offer').length %>
                    </div>
                    <div class="stat-label">Kar≈üƒ± Teklif</div>
                </div>
            </div>

            <!-- Revizyon Listesi -->
            <% if (revisions.length > 0) { %>
                <div class="card">
                    <div style="display: grid; gap: 1.5rem;">
                        <% revisions.forEach(order => { %>
                        <div class="revision-item" 
                             data-status="<%= order.revisionRequest.status %>"
                             style="padding: 1.5rem; background: var(--medium-gray); border-radius: 10px; border-left: 4px solid <%= getRevisionStatusColor(order.revisionRequest.status) %>;">
                            
                            <div style="display: flex; justify-content: between; align-items: start; gap: 2rem; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <h3 style="color: var(--white); margin: 0;"><%= order.title %></h3>
                                        <span class="status-badge status-<%= order.revisionRequest.status %>">
                                            <%
                                                const revisionStatusText = {
                                                    'pending': '‚è≥ Beklemede',
                                                    'accepted': '‚úÖ Kabul Edildi',
                                                    'rejected': '‚ùå Reddedildi',
                                                    'counter_offer': 'üí° Kar≈üƒ± Teklif'
                                                };
                                            %>
                                            <%= revisionStatusText[order.revisionRequest.status] %>
                                        </span>
                                    </div>
                                    
                                    <div style="color: #ccc; margin-bottom: 0.5rem;">
                                        <strong>Kullanƒ±cƒ±:</strong> <%= order.user.name %> (<%= order.user.email %>)
                                    </div>
                                    
                                    <div style="color: #ccc; font-size: 0.875rem;">
                                        <strong>ƒ∞stek Tarihi:</strong> 
                                        <%= new Date(order.revisionRequest.requestedAt).toLocaleDateString('tr-TR', { 
                                            year: 'numeric', 
                                            month: 'long', 
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <a href="/admin/orders/<%= order._id %>" class="btn" style="padding: 0.5rem 1rem;">
                                        üëÅÔ∏è Sipari≈üe Git
                                    </a>
                                    
                                    <% if (order.revisionRequest.status === 'pending') { %>
                                    <button onclick="acceptRevision('<%= order._id %>')" class="btn btn-success" style="padding: 0.5rem 1rem;">
                                        ‚úÖ Kabul Et
                                    </button>
                                    <button onclick="rejectRevision('<%= order._id %>')" class="btn btn-danger" style="padding: 0.5rem 1rem;">
                                        ‚ùå Reddet
                                    </button>
                                    <button onclick="counterOfferRevision('<%= order._id %>')" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                        üí° Kar≈üƒ± Teklif
                                    </button>
                                    <% } %>
                                </div>
                            </div>
                            
                            <!-- Revizyon A√ßƒ±klamasƒ± -->
                            <div style="background: var(--dark-gray); padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                                <strong style="color: var(--white); display: block; margin-bottom: 0.5rem;">üìù Kullanƒ±cƒ± A√ßƒ±klamasƒ±:</strong>
                                <p style="color: #ccc; line-height: 1.6; margin: 0;"><%= order.revisionRequest.description %></p>
                            </div>
                            
                            <!-- Orijinal Sipari≈ü Bilgileri -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <strong style="color: #ccc; font-size: 0.875rem;">Orijinal Fiyat</strong>
                                    <div style="color: var(--white);">
                                        <% if (order.price > 0) { %>
                                            <%= order.price %> TL
                                        <% } else { %>
                                            <span style="color: #ccc;">-</span>
                                        <% } %>
                                    </div>
                                </div>
                                
                                <div>
                                    <strong style="color: #ccc; font-size: 0.875rem;">Teslim Tarihi</strong>
                                    <div style="color: var(--white);">
                                        <% if (order.deadline) { %>
                                            <%= new Date(order.deadline).toLocaleDateString('tr-TR') %>
                                        <% } else { %>
                                            <span style="color: #ccc;">-</span>
                                        <% } %>
                                    </div>
                                </div>
                                
                                <div>
                                    <strong style="color: #ccc; font-size: 0.875rem;">Sipari≈ü Durumu</strong>
                                    <div>
                                        <span class="status-badge status-<%= order.status %>" style="font-size: 0.875rem;">
                                            <%
                                                const statusText = {
                                                    'pending': 'Beklemede',
                                                    'in_progress': '√úretimde',
                                                    'delivered': 'Teslim Edildi',
                                                    'revision': 'Revizyonda',
                                                    'cancelled': 'ƒ∞ptal Edildi'
                                                };
                                            %>
                                            <%= statusText[order.status] %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Admin Yanƒ±tƒ± -->
                            <% if (order.revisionRequest.counterOffer) { %>
                            <div style="background: rgba(0, 123, 255, 0.1); padding: 1rem; border-radius: 5px; border-left: 4px solid var(--accent);">
                                <strong style="color: var(--white); display: block; margin-bottom: 0.5rem;">üí° Admin Yanƒ±tƒ±:</strong>
                                <p style="color: #ccc; line-height: 1.6; margin: 0;"><%= order.revisionRequest.counterOffer %></p>
                            </div>
                            <% } %>
                            
                            <!-- ƒ∞≈ülem Ge√ßmi≈üi -->
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
                                <strong style="color: #ccc; font-size: 0.875rem;">ƒ∞≈ülem Ge√ßmi≈üi:</strong>
                                <div style="color: #888; font-size: 0.875rem; margin-top: 0.5rem;">
                                    ‚Ä¢ <%= new Date(order.createdAt).toLocaleDateString('tr-TR') %> - Sipari≈ü olu≈üturuldu<br>
                                    ‚Ä¢ <%= new Date(order.revisionRequest.requestedAt).toLocaleDateString('tr-TR') %> - Revizyon istendi
                                    <% if (order.revisionRequest.status !== 'pending') { %>
                                        <br>‚Ä¢ <%= new Date(order.updatedAt).toLocaleDateString('tr-TR') %> - Revizyon <%= order.revisionRequest.status === 'accepted' ? 'kabul edildi' : order.revisionRequest.status === 'rejected' ? 'reddedildi' : 'i√ßin kar≈üƒ± teklif sunuldu' %>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                </div>
            <% } else { %>
                <div class="card">
                    <div style="text-align: center; padding: 4rem 2rem; color: #ccc;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîÑ</div>
                        <h3 style="color: var(--white); margin-bottom: 0.5rem;">Hen√ºz revizyon isteƒüi bulunmuyor</h3>
                        <p>Kullanƒ±cƒ±lar revizyon istediƒüinde burada listelenecek</p>
                    </div>
                </div>
            <% } %>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="/js/main.js"></script>
    <% if (user && user.role === 'admin') { %>
        <script src="/js/admin.js"></script>
    <% } else if (user) { %>
        <script src="/js/user.js"></script>
    <% } %>

    <!-- Revizyon Karar Modal -->
    <div id="revisionDecisionModal" class="modal" style="display: none;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--white); margin: 0;" id="decisionModalTitle">Revizyon Kararƒ±</h3>
                <button onclick="closeDecisionModal()" style="background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            
            <form id="decisionForm">
                <input type="hidden" id="decisionOrderId">
                <input type="hidden" id="decisionType">
                
                <div class="form-group" id="counterOfferGroup" style="display: none;">
                    <label for="counterOfferMessage" class="form-label">Kar≈üƒ± Teklif Mesajƒ±</label>
                    <textarea 
                        id="counterOfferMessage" 
                        class="form-control" 
                        rows="4" 
                        placeholder="Kullanƒ±cƒ±ya g√∂ndermek istediƒüiniz kar≈üƒ± teklif mesajƒ±nƒ± yazƒ±n..."
                        required
                    ></textarea>
                </div>
                
                <div class="form-group" id="rejectReasonGroup" style="display: none;">
                    <label for="rejectReason" class="form-label">Reddetme Nedeni</label>
                    <textarea 
                        id="rejectReason" 
                        class="form-control" 
                        rows="4" 
                        placeholder="Reddetme nedeninizi a√ßƒ±klayƒ±n..."
                        required
                    ></textarea>
                </div>
                
                <div id="acceptMessage" style="display: none;">
                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                        <p style="color: #ccc; margin: 0; text-align: center;">
                            ‚úÖ Bu revizyon isteƒüini kabul etmek istediƒüinizden emin misiniz?
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" onclick="closeDecisionModal()" class="btn btn-outline" style="flex: 1;">
                        ƒ∞ptal
                    </button>
                    <button type="submit" class="btn" style="flex: 1;" id="decisionSubmitBtn">
                        G√∂nder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function getRevisionStatusColor(status) {
        const colors = {
            'pending': 'var(--warning)',
            'accepted': 'var(--success)',
            'rejected': 'var(--danger)',
            'counter_offer': 'var(--accent)'
        };
        return colors[status] || 'var(--light-gray)';
    }

    // Revizyon filtreleme
    document.getElementById('revisionFilter').addEventListener('change', function(e) {
        const status = e.target.value;
        const items = document.querySelectorAll('.revision-item');
        
        items.forEach(item => {
            if (status === 'all') {
                item.style.display = 'block';
            } else {
                if (item.dataset.status === status) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            }
        });
    });

    // Revizyon kabul etme
    function acceptRevision(orderId) {
        document.getElementById('decisionOrderId').value = orderId;
        document.getElementById('decisionType').value = 'accept';
        document.getElementById('decisionModalTitle').textContent = 'Revizyonu Kabul Et';
        document.getElementById('acceptMessage').style.display = 'block';
        document.getElementById('counterOfferGroup').style.display = 'none';
        document.getElementById('rejectReasonGroup').style.display = 'none';
        document.getElementById('decisionSubmitBtn').textContent = '‚úÖ Kabul Et';
        document.getElementById('decisionSubmitBtn').className = 'btn btn-success';
        document.getElementById('revisionDecisionModal').style.display = 'flex';
    }

    // Revizyon reddetme
    function rejectRevision(orderId) {
        document.getElementById('decisionOrderId').value = orderId;
        document.getElementById('decisionType').value = 'reject';
        document.getElementById('decisionModalTitle').textContent = 'Revizyonu Reddet';
        document.getElementById('acceptMessage').style.display = 'none';
        document.getElementById('counterOfferGroup').style.display = 'none';
        document.getElementById('rejectReasonGroup').style.display = 'block';
        document.getElementById('decisionSubmitBtn').textContent = '‚ùå Reddet';
        document.getElementById('decisionSubmitBtn').className = 'btn btn-danger';
        document.getElementById('revisionDecisionModal').style.display = 'flex';
    }

    // Kar≈üƒ± teklif sunma
    function counterOfferRevision(orderId) {
        document.getElementById('decisionOrderId').value = orderId;
        document.getElementById('decisionType').value = 'counter_offer';
        document.getElementById('decisionModalTitle').textContent = 'Kar≈üƒ± Teklif Sun';
        document.getElementById('acceptMessage').style.display = 'none';
        document.getElementById('counterOfferGroup').style.display = 'block';
        document.getElementById('rejectReasonGroup').style.display = 'none';
        document.getElementById('decisionSubmitBtn').textContent = 'üí° Teklif G√∂nder';
        document.getElementById('decisionSubmitBtn').className = 'btn';
        document.getElementById('revisionDecisionModal').style.display = 'flex';
    }

    function closeDecisionModal() {
        document.getElementById('revisionDecisionModal').style.display = 'none';
        document.getElementById('decisionForm').reset();
    }

    // Karar formu g√∂nderme
    document.getElementById('decisionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const orderId = document.getElementById('decisionOrderId').value;
        const decisionType = document.getElementById('decisionType').value;
        const counterOffer = document.getElementById('counterOfferMessage').value;
        const rejectReason = document.getElementById('rejectReason').value;
        
        let decision, message;
        
        switch(decisionType) {
            case 'accept':
                decision = 'accepted';
                message = '';
                break;
            case 'reject':
                decision = 'rejected';
                message = rejectReason;
                break;
            case 'counter_offer':
                decision = 'counter_offer';
                message = counterOffer;
                break;
        }
        
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '‚è≥ G√∂nderiliyor...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/admin/revisions/${orderId}/decision`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    decision,
                    counterOffer: message
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Revizyon kararƒ± g√∂nderildi!', 'success');
                closeDecisionModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(data.error || 'Karar g√∂nderilirken bir hata olu≈ütu!', 'error');
                submitBtn.innerHTML = document.getElementById('decisionSubmitBtn').textContent;
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Revizyon kararƒ± g√∂nderme hatasƒ±:', error);
            showNotification('ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu!', 'error');
            submitBtn.innerHTML = document.getElementById('decisionSubmitBtn').textContent;
            submitBtn.disabled = false;
        }
    });

    // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapatma
    document.getElementById('revisionDecisionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDecisionModal();
        }
    });
    </script>

    <style>
    .revision-item {
        transition: all 0.3s ease;
    }

    .revision-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    </style>
</body>
</html>